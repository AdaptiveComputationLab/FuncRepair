#!/bin/bash

#############################################################################
#  THIS SCRIPT HAS BEEN CUSTOMIZED FOR PRD BUILD AND REQUIRES
#              genprog_setup.bash $1
# author: pdreiter
#############################################################################
# this script assumes that there exists a directory with all PRD components here:
# generated by make_prd_srcdir.bash
# ${ROOT_DIR}/pchallenges/<CB>:
#       - <CB>
#       - configuration-func-repair
#       - test.sh
#       - pov_*.pov
#       - decompiled_source.c <= assuming that this is the PRD source
#       - funcinsert.py
#       - script.ld
#       - Makefile.genprog
#       - Makefile.prophet
#       - poller/
#       - libsrc/
#       - tools/
# 
#############################################################################

SCRIPT_DIR=$(dirname $(realpath $0))
ROOT_DIR=$(dirname ${SCRIPT_DIR})
TEST=$1
CFG_DEST=$2

DEST=$(realpath "${CFG_DEST}/${TEST}")

BASEREVLOG=${TEST}
REVLOGEXT="revlog"
CONFEXT="conf"

POV=$(echo $TEST | perl -p -e 's/^.*\.(pov_\d+)$/$1/')
CB=$(echo $TEST | perl -p -e 's/\.\d+\.pov_\d+$//')
FUNC=$(echo $TEST | perl -p -e 's/^.*\.(\d+)\.pov_\d+$/$1/')
PRD_SRC="${CB}_recomp_${FUNC}.c"

SRC_DIR="${ROOT_DIR}/pchallenges/${TEST}"

##PATCHED_FILENAMES=$(egrep -lr 'def *PATCH' ${SRC_DIR} | perl -p -e"s#${SRC_DIR}##;s#\s*\$# #")
#PATCHED_FILENAMES=$(ls ${SRC_DIR}/src/*.c* ${SRC_DIR}/lib/*.c* | perl -p -e"s#${SRC_DIR}/##;s#\s*\$# #")

neg=$(egrep 'neg\-tests' ${SRC_DIR}/configuration-func-repair | awk '{print $NF}')
pos=$(egrep 'pos\-tests' ${SRC_DIR}/configuration-func-repair | awk '{print $NF}')

neg_test=$(egrep -a2 $POV $SRC_DIR/test.sh | egrep '^n[0-9]+)' | head -n 1 | sed 's/n//;s/)//')
(( neg_test-=1 ))
if [[ ! -e ${DEST} ]]; then 
mkdir -p ${DEST}
fi
#NUM=10;
#EXE=Message_Service.trampoline.bin ;
i=0
k=0
REVLOG="${DEST}/${BASEREVLOG}.${REVLOGEXT}"
CONF="${DEST}/${BASEREVLOG}.${CONFEXT}"
echo "-" > $REVLOG
echo "-" >> $REVLOG
neglimit=$(($neg-1))
echo "Diff Cases: Tot $neg" >> $REVLOG
      indx="$neg_test"
      echo -n "$indx " >> $REVLOG

#for k in $(seq 0 $neglimit); do
#      indx="$k"
#      echo -n "$indx " >> $REVLOG
#done
echo "" >> $REVLOG
echo "Positive Cases: Tot $pos" >> $REVLOG
k=$neg
for i in $(seq $k $pos); do
      indx="$i"
      echo -n "$indx " >> $REVLOG
done
echo "" >> $REVLOG
echo "Regression Cases: Tot 0" >> $REVLOG

echo "revision_file=${REVLOG}" > ${CONF}
echo "src_dir=${ROOT_DIR}/pchallenges/${TEST}" >> ${CONF}
echo "test_dir=${ROOT_DIR}/pchallenges/${TEST}" >> ${CONF}
echo "build_cmd=${SCRIPT_DIR}/cgc-e2eprd-build.py" >> ${CONF}
echo "test_cmd=${SCRIPT_DIR}/cgc-e2eprd-test.py" >> ${CONF}
echo "localizer=profile" >> ${CONF}
echo "bugged_file=${PRD_SRC}" >> ${CONF}
echo "fixed_out_file=prd_prophet_repair_${TEST}_" >> ${CONF}
echo "single_case_timeout=12" >> ${CONF}
echo "wrap_ld=no" >> ${CONF}
echo "challenge=${TEST}" >> ${CONF}
echo "makefile=Makefile.prophet" >> ${CONF}
echo "makefile_target=all" >> ${CONF}


#  for A in $(seq 1 $neg); do
#  CONF="${DEST}/${BASEREVLOG}.pov_${A}.${CONFEXT}"
#  REVLOG="${DEST}/${BASEREVLOG}.pov_${A}.${REVLOGEXT}"
#  echo "-" > $REVLOG
#  echo "-" >> $REVLOG
#  echo "Diff Cases: Tot 1" >> $REVLOG
#  indx=$(($A-1))
#  echo -n "$indx " >> $REVLOG
#  echo "" >> $REVLOG
#  echo "Positive Cases: Tot $pos" >> $REVLOG
#  k=$neg
#  for i in $(seq $k $pos); do
#        indx="$i"
#        echo -n "$indx " >> $REVLOG
#  done
#  echo "" >> $REVLOG
#  echo "Regression Cases: Tot 0" >> $REVLOG
#  
#  # generate pov-specific .conf file
#  echo "revision_file=${REVLOG}" > ${CONF}
#  echo "src_dir=${ROOT_DIR}/pchallenges/${TEST}" >> ${CONF}
#  echo "test_dir=${ROOT_DIR}/pchallenges/${TEST}" >> ${CONF}
#  echo "build_cmd=${SCRIPT_DIR}/cgc-prd-build.py" >> ${CONF}
#  echo "test_cmd=${SCRIPT_DIR}/cgc-prd-test.py" >> ${CONF}
#  echo "localizer=profile" >> ${CONF}
#  echo "bugged_file=${PRD_SRC}" >> ${CONF}
#  echo "fixed_out_file=prd_prophet_repair_${TEST}_pov_${A}_" >> ${CONF}
#  echo "single_case_timeout=12" >> ${CONF}
#  echo "wrap_ld=no" >> ${CONF}
#  echo "challenge=${TEST}" >> ${CONF}
#  echo "makefile=Makefile.prophet" >> ${CONF}
#  echo "makefile_target=all" >> ${CONF}
#  done
#  
