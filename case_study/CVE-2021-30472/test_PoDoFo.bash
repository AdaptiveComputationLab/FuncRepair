#!/bin/bash 
# author: pdreiter
# date : 8/5/2021
# purpose: collect and run test content for CVE-2021-30472
# Example run:
#   $0 podofo-0.9.7/build32/tools/podofopdfinfo/podofopdfinfo
# Example cgfl-enabled run:
#   $0 podofo-0.9.7/build32/tools/podofopdfinfo/podofopdfinfo CGFL

scriptdir=$(dirname $(realpath $0))
exe=$1
if [[ "$exe"!=*"trampoline.bin" ]];then
#safeguarding against running CGFL on a PRD binary
cgfl=$2
CGFL_OUT="cgfl_out"
fi

#this variable hardcoded to directory where PoDoFo is installed
src_dir=podofo-0.9.7/tools/podofopdfinfo,podofo-0.9.7/src

testdir=$scriptdir/test_podofo
## getting test content for PoDoFo and CVE-2021-30472
if [[ ! -d $testdir/novapdfs ]]; then 
mkdir -p $testdir/novapdfs
pushd $testdir/novapdfs
wget https://download.novapdf.com/download/samples/pdf-example-encryption.pdf
wget https://download.novapdf.com/download/samples/pdf-example-password.pdf
wget https://download.novapdf.com/download/samples/pdf-example-fonts.pdf
wget https://download.novapdf.com/download/samples/active-pdf-links.pdf
wget https://download.novapdf.com/download/samples/pdf-example-bookmarks.pdf
wget https://download.novapdf.com/download/samples/pdf-example-watermarks.pdf
popd
fi
if [[ ! -d $testdir/povs ]]; then 
mkdir -p $testdir/povs
pushd $testdir/povs
wget https://sourceforge.net/p/podofo/tickets/132/attachment/bug4
popd
fi
#exe=tools/podofopdfinfo/podofopdfinfo
inf=$(basename $exe)

run_test(){
local id_=$1
if [[ ! -z $cgfl ]];then
mkdir -p $CGFL_OUT
echo "/usr/bin/valgrind --tool=callgrind --log-file=$CGFL_OUT/$id_.cgfl.log --callgrind-out-file=$CGFL_OUT/$id_.cg.out ${@:2}"
/usr/bin/valgrind --tool=callgrind --log-file=$CGFL_OUT/$id_.cgfl.log --callgrind-out-file=$CGFL_OUT/$id_.cg.out ${@:2}
else
${@:2}
fi
}

cgfl_run(){
local EXE=$1 
r_out=r_scripts
if [[ ! -z $cgfl ]];then
    mkdir -p $r_out
        echo "$PRD_BASE_DIR/tools/cgfl.py --top-k-percent 0.35 --r-out $r_out --exe $EXE \
        --src $src_dir \
        --results $CGFL_OUT \
        --byte-min 45 --reduce "

        $PRD_BASE_DIR/tools/cgfl.py --top-k-percent 0.35 --r-out $r_out --exe $EXE \
        --src $src_dir \
        --results $CGFL_OUT \
        --byte-min 45  --reduce
fi


}


mkdir -p logs
pid=1
nid=1
for i in "" D C P O N; do
    for pdf in $(ls $testdir/novapdfs/*.pdf); do
        run_test p$pid $exe $i $pdf |& tee logs/$inf.p$pid.log
		((pid+=1))
    done
    run_test n$nid $exe $i $testdir/povs/bug4 |& tee logs/$inf.n$nid.log
	((nid+=1))
done

cgfl_run $exe

